<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>An Introduction to Modern Authentication and Authorization</title>

		<meta name="description" content="Theory and hands-on examples to do web based Authentication and Authorization">
		<meta name="author" content="Lars Kåre Skjørestad">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/simple.css" id="theme">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css" id="highlight-theme">

	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">

				<!-- Front page -->
				<section style="text-align: left;">
					<h1>Modern A&A</h1>
					<h4>Authentication and Authorization</br>
					oAuth2 and OpenID Connect (OICD)</h4>
				</p>
					<small>An simple introduction to a endless complex topic</small>
					<p>
						<small><a href="https://loop.equinor.com" target="_blank">Equinor</a></Equinor> <font style="color:red;">#AppSec</font> community</a></small>
					</p>
				</section>


<!-- Objectives part-->
				<section>
					<section>
						<h1>Objectives</h1>
					</section>

					<section>
						<h3>Workshop objectives </h3>
						<blockquote style="color:dodgerblue">De-mystify, build confidence and prepare for further exploration of A&A</blockquote>
						<h4>Highlights</h4>
						<ul style="font-size: 80%;">
							<li>Give an introduction to the basics of modern web A&A</li>
							<li>Explore RFC (specs) and Azure Implementation</li>
							<li>Code a few A&A scenarios</li>
							<li>Insights into threats and security best current practices (BCP)</li>
						</ul>
					</section>
				</section>

<!-- Outlines part-->
				<section>
					<section>
						<h1>Workshop Outline</h1>
					</section>
					<section style="text-align: left;">
						<h3>Workshop outline</h3>
						<ul>
							<li>Which problems are we trying to solve?</li>
							<li>Practicalities</li>
							<li>The basics of A&A</li>
							<li>Exercises (10+1)</li>
							<Sharing>Raw flows, add authentication to web app, using frameworks & libraries, accessing 3rd party api,
								refresh tokens, single page web app (SPA), PKCE, protecting web api's and On-Behalf-Of flow.
							<li>Deploy application to the Cloud (using Radix)</li>
						</ul>
					</section>
				</section>


<!-- A day in the life of a modern app-->
				<section>
						<section>
							<h3>A day in the life of</h3>
							<h2 style="color:red">sMailandStuff</h2>
							<Small>The mature web Swiss Army Knife</Small>
							<p></p>
							<a href="https://webapp-smailandstuff-production.playground.radix.equinor.com/"
							target="_blank">sMailandStuff</a> on Radix
						</section>

						<section>
							<h3>The players</h3>
							<img src="./graphics/export/actors.jpg" width="75%">
						</section>
				</section>
			
<!-- The Delegation problem-->
				<section>
							
					<section>
						<h1>The delegation problem</h1>
						<small style="color:blue">Giving access to 3rd parties</small>
						<p></p><small>API's are a driving force</small>
					</section>

					<section>
						<h3>Old style A&A</h3>
						<small>Impersonating, Direct Authenticating</small><p></p>
						<img src="./graphics/export/my_super_app_old.jpg" width="75%">
					</section>
					<section>
						<h3>Old style A&A</h3>
						<small>Impersonating, Direct Authenticating</small>
						<table>
							<tr>
								<td><img src="./graphics/export/my_super_app_old.jpg" ></td>
								<td style=" vertical-align: top;">
									<ul>
										<li>Store id/password for each service</li>
										<li>No way to revoke access</li>
										<li>Access not time limited</li>
										<li>Full access only - not granular</li>
									</ul>
								</td>
							</tr>
						</table>
					</section>


					<section>
						<h3>New Style A&A</h3>
						<small>Delegating</small><p></p>
						<img src="./graphics/export/my_super_app_new.jpg" width="75%">
					</section>
					<section>
						<h3>New style A&A</h3>
						<table>
							<tr>
								<td><img src="./graphics/export/my_super_app_new.jpg" ></td>
								<td style=" vertical-align: top;">
									<ul>
										<li>Id/password not stored on client</li>
										<li>Access can be revoked</li>
										<li>Access can be time limited</li>
										<li>Access can be granular</li>
										<li>Access is delegated from resource owner to client</li>
									</ul>
								</td>
							</tr>
						</table>
					</section>
				</section>

<!-- Disclaimer part-->
				<section>
					<h1>Disclaimer</h1>
					<p>The more I learn about the topic at hand, the more I realize how complex it is. I am not an expert.
						 Very rarely is the answer black and white. Context is important.
						 I assume that quite a few of you have experience, insight and knowledge to share.
						 Please share! Sharing is caring!</p>
					<p style="color:blue; font-size: 70%;">Code examples are not production quality - they are happy-path</p>
				</section>

<!-- The practicalities & useful links part -->
				<section>
					<section>
						<h1>Practicalities</h1>
						<h3><a href="https://equinor.slack.com/archives/CQUQN8QQL" target="_blank">#appsec-authentication-and-authorization-course</a></h3> on Slack
					</section>
					<section>
							<h1>Useful links</h1>
							<small>
								<ul>
									<li><a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/" target="_blank">Microsoft Identity Platform</a></li>
									<li><a href="https://oauth.net/2/" target="_blank">oAuth2.net</a></li>
									<li><a href="https://tools.ietf.org/html/rfc6749" target="_blank">The OAuth Authorization Framework (rfc 6749)</a></li>
									<li><a href="https://openid.net/connect/" target="_blank">OpenID Connect</a></li>
								</ul>
							</small>
						</section>
						<section>
							<h3>Run-time environments -</br> known differences</h3>
							<ul>
								<li>Examples uses Unix path notation "./src". </br>In Windows this will be "src/</li>
								<li>Scripts in course code, like <span style="color: blue">npm start</span> uses Linux notation. Must be changed for Windows environments</li>
							</ul>
						</section>
				</section>

<!-- The basic of A&A part 1-->
				<section>
					<section>
						<h1>The basics of A&A</h1>
						<h4>Part #1</h4>
					</section>
					<section>
						<h3>Authentication vs. Authorization</h3>
						<p><span style="color:red">Authentication</span> =</br>is the mechanism to verify the identity of a user</p>
						<p><span style="color:red">Authorization</span> = </br>is the mechanism to verify access to a resource</p>
					</section>
					<section>
						<h3>oAuth2</h3>
						<blockquote style="font-size: 75%">
						The OAuth 2.0 authorization framework enables a
						</br> third-party application to obtain limited access to an HTTP service,
						</br></br>either on behalf of a resource owner
						</br>by orchestrating an approval interaction between the resource owner and the HTTP service
						</br></br>or by allowing the third-party application to obtain access on its own behalf.</blockquote>
						<small><a style="font-size: 200%;color: red" href="https://tools.ietf.org/html/rfc6749" target="_blank">oAuth2</a> is a <strong>delegation protocol</strong>, a means of giving someone who controls a resource the capability to delegate access to the resource on their behalf (without impersonating).</small>
					</section>

					<section>
						<h3>oAuth2 vs OpenID Connect</h3>
						<ul>
							<li>oAuth is for delegation, the goal is to access api's</li>
							<ul>
								<li>To get a ticket (token) which gives access to a protected resource</li>
							</ul>
							<li>OpenID Connect is an identify layer on top of oAuth</li>
							<ul>
								<li>Answering key question: Who is logged in?</li>
								<li>Defines user authentication metadata</li>
								<li>Can control authentication</li>
								<li>Supports federation</li>
							</ul>
						</ul>
					</section>

					<section style="font-size: 75%">
						<h3>oAuth2 Roles/Actors</h3>
						<p><div style="color:blue">resource owner</div>
						An entity capable of granting access to a protected resource.
						When the resource owner is a person, it is referred to as an
						end-user.
						</p>
						<p><div style="color:blue">resource server</div>
						The server hosting the protected resources, capable of accepting
						and responding to protected resource requests using access tokens.
						</p>
						<p><div style="color:blue">client</div>
						An application making protected resource requests on behalf of the
						resource owner and with its authorization.  The term "client" does
						not imply any particular implementation characteristics (e.g.,
						whether the application executes on a server, a desktop, or other
						devices).
						</p>
						<p><div style="color:blue"> authorization server</div>				
						The server issuing access tokens to the client after successfully
						authenticating the resource owner and obtaining authorization.
						</p>
					</section>
					<section>
						<h3>Actors</h3>
						<img src="./graphics/export/actors.jpg" width="75%">
					</section>
					<section>
						<h4><a href="https://tools.ietf.org/html/rfc6749#section-1.2"
							target="_blank">Abstract protocol flow (rfc6749)</a></h4>
						<pre>
+--------+                               +---------------+
|        |--(A)- Authorization Request ->|   Resource    |
|        |                               |     Owner     |
|        |<-(B)-- Authorization Grant ---|               |
|        |                               +---------------+
|        |
|        |                               +---------------+
|        |--(C)-- Authorization Grant -->| Authorization |
| Client |                               |     Server    |
|        |<-(D)----- Access Token -------|               |
|        |                               +---------------+
|        |
|        |                               +---------------+
|        |--(E)----- Access Token ------>|    Resource   |
|        |                               |     Server    |
|        |<-(F)--- Protected Resource ---|               |
+--------+                               +---------------+
						</pre>
					</section>
					<section>
						<h4 style="text-align: left;">Abstract protocol flow</h4>
						<pre style="font-size: 35%; text-align: left;">
+-- <span style="color:red">Resource</span> --+ +-- <span style="color: blue;">Client</span> -- + +- <span style="color:bluegreen">Authorization</span> -+ +--<span style="color:violet"> Resource</span> --+
+    Owner     + +             + +     Server      + +   Server     +
+--------------+ +-------------+ +-----------------+ +--------------+
     -                   -                -                     -
     |  <span style="color:blue">(A)Client request</span>|                |                     |
     |      <span style="color:blue">Authorization</span>|                |                     |
     |<------------------|                |                     |
     |- - - - - - - - - - - - - - - - - ->|                     |
     |                   |                |                     |
     |<span style="color:red">(B) Resource Owner</span> |                |                     |
     |<span style="color:red">Grants authorization</span>                |                     |
     |----------------------------------->|                     |
     |                   |<- - - - - - - -|                     |
     |                   |                |                     |
     |                   |<span style="color:blue">(C) Client send</span> |                     |
     |                   |  <span style="color:blue">Authorization</span> |                     |
     |                   |          <span style="color:blue">grant</span> |                     | 
     |                   |--------------->|                     |
     |                   |                |                     |
     |                   | <span style="color:bluegreen">(D)Autorization</span>|                     |
     |                   |    <span style="color:bluegreen">server sends</span>|                     |
     |                   |    <span style="color:bluegreen">access token</span>|                     |
     |                   |<---------------|                     |
     |                   |                |                     |
     |                   |<span style="color:blue">(E)Client sends</span> |                     |
     |                   |<span style="color:blue">Access Token</span>    |                     |
     |                   |------------------------------------->|
     |                   |                |                     |
     |                   |                |<span style="color:violet">(F)Protected resource</span>|
     |                   |                |       <span style="color:violet">sends resource</span>|
     |                   |<-------------------------------------|
     |                   |                |                     |
     -                   -                -                     -                                   
						</pre>
					</section>

					<section>
						<h2>What oAuth is and is not</h2>
						<ul style="font-size: 80%;">
							<li>Is not defined outside HTTP</li>
							<li>Is "requiring" TLS</li>
							<li>Is not an authentication protocol</li>
							<li>Is not processing authorization</li>
							<li>Is not defining user-to-user delegation</li>
							<li>Is not defining a token format</li>
							<li>Is not defining crypto methods</li>
							<li>Is not a single protocol - </br>it supports multiple use cases -</br> it's a protocol for protocols</li>
						</ul>
					</section>

					<section>
						<h3>Obtaining authorization - </br>the oauth Dance</h3>
						<blockquote style="font-size: 80%;">To request an access token, the client obtains authorization from the resource owner.  The authorization is expressed in the form of an authorization grant, which the client uses to request the access token.  OAuth defines four grant types: <span style="color:red">authorization code, implicit, resource owner password credentials</span>, and <span style="color:red">client credentials</span>.  It also provides an extension mechanism for defining additional grant types.</blockquote>
				</section>

				<section>
					<h2>It's about getting tokens</h2>
					<ul>
						<li>Access token (to provide access)</li>
						<li>ID token (to prove identity)</li>
						<li>Refresh token</li>
					</ul>
					<p>More on tokens later....</p>
				</section>

				<section>
					<h3><a href="https://tools.ietf.org/html/rfc6749#section-4.1"
						target="_blank">Authorization Code Grant</a></h3>
						<small><a href="https://tools.ietf.org/html/rfc6749#section-4.1" target="_blank">rfc6749 #4.1</a></small>
					<pre style="font-size: 40%;">

+----------+
| Resource |
|   Owner  |
|          |
+----------+
 ^
 |
(B)
+----|-----+          Client Identifier      +---------------+
|         -+----(A)-- & Redirection URI ---->|               |
|  User-   |                                 | Authorization |
|  Agent  -+----(B)-- User authenticates --->|     Server    |
|          |                                 |               |
|         -+----(C)-- Authorization Code ---<|               |
+-|----|---+                                 +---------------+
|    |                                           ^      v
(A)  (C)                                         |      |
|    |                                           |      |
^    v                                           |      |
+---------+                                      |      |
|         |>---(D)-- Authorization Code ---------'      |
|  Client |          & Redirection URI                  |
|         |                                             |
|         |<---(E)----- Access Token -------------------'
+---------+       (w/ Optional Refresh Token)			
					</pre>
				</section>
				<section>
					<h3>Authorization Code Grant</h3>
					<img src="./graphics/export/oauth_code_flow.jpg" width="75%">
				</section>

				<section>
					<h3>Authorization Code Grant</h3>
					<table>
						<tr>
							<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
							<td style=" vertical-align: top;">
								<p>-1-</p>
								Client via user agent - initiates
							</td>
						</tr>
					</table>
				</section>

				<section>
						<h3>Authorization Code Grant</h3>
						<table>
							<tr>
								<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
								<td style=" vertical-align: top;">
									<p>-2-</p>
									<span style="font-size: 70%;">
									GET /authorize? </br>
									client_id=client </br>
									&scope=(optional) </br>
									&reponse_type=code </br>
									&state=1234
									&redirect_uri=
									https://app/callback
									</span>
								</td>
							</tr>
						</table>
				</section>

				<section>
						<h3>Authorization Code Grant</h3>
						<table>
							<tr>
								<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
								<td style=" vertical-align: top;">
									<p>-3-</p>
									Authentication is handed over to authentication server
								</td>
							</tr>
						</table>
				</section>

				<section>
						<h3>Authorization Code Grant</h3>
						<table>
							<tr>
								<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
								<td style=" vertical-align: top;">
									<p>-4-</p>
									<span style="font-size: 70%;">
									303 redirect
									https://app/callback? </br>
									code=o-t-c</br>
									&state=1234</br>		
									</span>
								</td>
							</tr>
						</table>
				</section>

				<section>
						<h3>Authorization Code Grant</h3>
						<table>
							<tr>
								<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
								<td style=" vertical-align: top;">
									<p>-5-</p>
									<span style="font-size: 70%;">
									POST /token
									grant_type=authorization_code</br>
									&client_id=</br>
									&client_secret=</br>
									&code=</br>
									&redirect_uri=</br>
									</span>
								</td>
							</tr>
						</table>
				</section>

				<section>
						<h3>Authorization Code Grant</h3>
						<table>
							<tr>
								<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
								<td style=" vertical-align: top;">
									<p>-6-</p>
									<span style="font-size: 70%;">
									{</br>
											"access_token":"2YotnFZFEjr1zCsicMWpAA",
											"token_type":"Bearer",
											"expires_in":3600,
											"refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA"
										</br>}
									</span>
								</td>
							</tr>
						</table>
				</section>


				<section>
						<h2>OpenID Connect (<a href="https://openid.net/connect/" target="_blank">OICD</a>)</h2>
						<ul style="font-size: 80%;">
							<li><span style="color:red">Identity</span> layer built on-top of oAuth2</li>
							<li>Answer to the "Who is logged in?" question</li>
							<li>Defines user authentication meta data</li>
							<li>Can control authentication</li>
							<lI>Enables federation</lI><p></p>
						</ul>
						<table style="font-size: 80%;">
							<thead>
								<tr>
									<td>oAuth2 term</td>
									<td>OICD term</td>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td>Resouce owner</td>
									<td>User</td>
								</tr>
								<tr>
									<td>Client</td>
									<td>Relying party</td>
								</tr>
								<tr>
									<td>Authorisation server, Protected resource</td>
									<td>Identity provider</td>
								</tr>
							</tbody>
						</table>
					</section>
	
					<section>
							<h3>OpenID Connect Code Flow</h3>
							<table>
								<tr>
									<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
									<td style=" vertical-align: top;">
										<p>-2-</p>
										<span style="font-size: 70%;">
										GET /authorize? </br>
										client_id=client </br>
										&scope=read+<span style="color:red">openid</span> </br>
										&reponse_type=code </br>
										&state=1234
										&redirect_uri=
										https://app/callback
										</span>
									</td>
								</tr>
							</table>
					</section>


					<section>
							<h3>OpenID Connect Code Flow</h3>
							<table>
								<tr>
									<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
									<td style=" vertical-align: top;">
										<p>-3-</p>
										Authentication is handed over to authentication server
									</td>
								</tr>
							</table>
					</section>

					<section>
							<h3>OpenID Connect Code Flow</h3>
							<table>
								<tr>
									<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
									<td style=" vertical-align: top;">
										<p>-4-</p>
										<span style="font-size: 70%;">
										303 redirect
										https://app/callback? </br>
										code=o-t-c</br>
										&state=1234</br>		
										</span>
									</td>
								</tr>
							</table>
					</section>

					<section>
							<h3>OpenID Connect Code Flow</h3>
							<table>
								<tr>
									<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
									<td style=" vertical-align: top;">
										<p>-5-</p>
										<span style="font-size: 70%;">
										POST /token 
										grant_type=authorization_code</br>
										&client_id=</br>
										&client_secret=</br>
										&code=</br>
										&redirect_uri=</br>
										</span>
									</td>
								</tr>
							</table>
					</section>

					<section>
							<h3>OpenID Connect Code Flow</h3>
							<table>
								<tr>
									<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
									<td style=" vertical-align: top;">
										<p>-6-</p>
										<span style="font-size: 70%;">
										{</br>
												"access_token":"ey2YotnFZFEjr1zCsicMWpAA",</br>
												"token_type":"Bearer",</br>
												<span style="color:red">"id_token": "eynndj3nn77hs7Hhjhjh"</span> ,</br>
												"expires_in":3600,</br>
												"refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA"</br>
											</br>}
										</span>
									</td>
								</tr>
							</table>
					</section>



						<section>
						<h2>OpenID Connect (OICD)</h2>
						<ul style="font-size: 70%";">
							<li>New <span style="color:red">IDToken</span> received upon successful authentication and serves as proof of who's authenticated</li>
							<li>Access tokens are not proof of authentication. They are not intended for client - rather the protected resource</li>
							<li>IDToken's can be given to client along with Access tokens</li>
							<li>IDTokens' are signed JWT tokens.</li>
							<li>ID tokens contains claims such as</li>
								<ul>
									<li>iss - issuer of the token</li>
									<li>sub - subject - user id from identity provider</li>
									<li>aud - audience - id for relying party</li>
									<li>exp - expiration time stamp</li>
								</ul>
							<li>For the Azure implementation, more documentation on the <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-protocols-oidc" target="_blank">Microsoft Identity Platform</a> doc pages.
							Explore attributes such as "prompt", "login_hint", "response_mode"</li>
						</ul>
					</section>


					<section>
						<h3>OAuth Flows that we have not covered</h3>
						<ul>
							<li>Client credentials</br>
								Typically service to service in protected environment
							</li>
							<li>Resource Owner Password Credentials</br>
								High trust envionments where the resource owner trusts it's credentials to the client
							</li>
							<li>(Implicit grant will be covered later)</li>
						</ul>
					</section>

					<section>
						<h1>Please note ...</h1>
						<ul>
							<li>Use Azure AD v2 endpoints whenever possible, V1 is about to be deprecated</li>
							<li>Be aware of doc and v1 vs. v2 (it's easy to read the wrong one)</li>
						</ul>
					</section>
				</section>

<!-- Exercise 1 -->
				<section>
					<section>
						<h1>Exercise - 1</h1>
						<h2>Raw Authorization Code Grant</h2>
					</section>	

					<section>
						<h2>Exercise Outline</h2>
						<ul style="font-size: 80%;">
							<li>Clone github repository</li>
							<li>Investigate <a href="https://tools.ietf.org/html/rfc6749#section-4.1" target="_blank">spec</a> and doc on <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-auth-code-flow" target="_blank">Azure</a></li>
							<li>Register app object in <a href="https://portal.azure.com" target="_blank">Azure AD</a></li>
							<li>Set-up postman</li>
							<li>Request authorization code</li>
							<li>Request an access token</li>
							<li>Explore tokens</li>
						</ul>
					</section>
					<section>
						<h2>Clone github repository</h2>
						<p><a style="font-size: 70%;" href"https://github.com/larskaare/WebAuthAuthorAndOtherCreatures" target="_blank">https://github.com/larskaare/WebAuthAuthorAndOtherCreatures</a></p>
						<pre><code class="hljs" style="font-size: 80%;" >git clone git@github.com:larskaare/WebAuthAuthorAndOtherCreatures.git</code></pre>
					</section>
					<section>
						<h3>Register application in Azure AD</h3>
						<ul style="font-size: 80%;">
							<li>Navigate to <a href="https://portal.azure.com" target="_blank">portal.azure.com</a> and find Azure Active Directory</li>
							<li>Select App registrations</br>(App registration vs. Enterprise Applications</li>
							<li>Register new application</li>
								<ul>
									<li>Activate "Application developer role" in "Privileged Identiy Management"</li>
									<li><span style="color:red">Name</span>: (inital)-(aa-client) or something else</li>
									<li><span style="color:red">Type</span>: Single tenant</li>
									<li><span style="color:red">Redirect uri</span>: http://localhost/auth</li>
								</ul>
							<li>Explore options for the new app registration</li>
						</ul>
					</section>

					<section>
						<h3>Set-up Postman</h3>
						<ul>
							<li>Start Postman</li>
							<li>Import "Azure AD v2.0 Protocols.postman_collection.json" from "./ex-1" folder</li>
						</ul>
					</section>

					<section>
						<h3>Request authorization code</h3>
						<ul style="font-size: 70%;">
							<li>Select "Oauth 2.0 Authorization Code Flow" -> GET Autorization request</li>					
							<li>Explore "endpoints" for application registration (Azure Portal)"</li>
							<ul>
								<li>Copy and substitute oAuth2 Authorization endpoint v2 to GET request</li>
								<li>Copy "client_id" to GET request parameter</li>
								<li>Change "redirect_url" to "http://localhost/auth" for GET request parameter</li>
							</ul>
							<li>Look at scope for GET request. It's OICD? RFC says optional, Azure AD says mandatory.</li>
							<li>Copy the GET request to clip board and execute from web browser </br> (the code is use once within seconds)</li>
							<li>Copy authorization code from "code" parameter in the browser response<br></br></li>
							<li>Explore changig "scope" and convert to "native" oAuth2 request</li>
							<li>Why do we have to execute request in web browser?</li>
							<li>Discuss security considerations</li>
							<li><span style="color:red">Good practice</span> : remove the localhost redirect from production applications</li>
						</ul>
					</section>
					
					<section>
						<h3>Request an access token</h3>
						<ul style="font-size: 70%;">
								<li>Select "POST - Token Request - Auth Code" from Postman collection</li>
								<li>Copy and substitute oAuth2 Token endpoint v2 to POST request</li>
								<li>Define client secret for application in Azure Portal</li>
								<li>Update body for POST request <span style="color:red">client_id, redirect_uri, client_secret, code</span><br>(code is from the GET request)</li>		
								<li>Send POST request</li>
								<li>Explore response</li>
								<li>Discuss security considerations (SSL, secrets, certificates, public vs. confidential client)</li>
							</ul>
					</section>

					<section>
						<h3>Explore tokens</h3>
						<ul style="font-size: 70%;">
							<li>Use <a href="https://jwt.ms" target="_blank">https://jwt.ms</a> to explore tokens</li>
							<li>Explore tokens, claims and dates</br> (access_token, refresh_token, id_token)</li>
							<li>Experiment with scope param
								</br>Scope profile+email will put "more" info into id_token
								</br>Scope offline_access will add refresh_token
							</li>
							<li>Discuss claims, optional claims, application manifest and <b>token config</b> in AD app object </li>
							<ul>
								<li>Standard claims in JWT tokens (<a href="https://tools.ietf.org/html/rfc7519#section-4" target="_blank">RFC 7519</a>)</li>
								<li>Registry for public claims to avoid naming conflicts - <a href="https://www.iana.org/assignments/jwt/jwt.xhtml" target="_blank">IANA</a></li>
								<li>Standard OICD JWT Token claims (<a href="https://openid.net/specs/openid-connect-core-1_0.html#StandardClaims" target="_blank">1.0</a>)</li>
							</ul>
							<li>Discuss security considerations (token validation, token storage)</li>
							<li><span style="color:red">Good practice</span>: Don't uses access tokens as proof of authentication. Access tokens are for the protected resource </li>
						</ul>
					</section>

				</section>

<!-- Exercise 2 :  -->					
				
				<section>
						<section>
							<h1>Exercise 2</h1>
							<h4>Web applicaton</h4>
							<h3>Getting an access token</h3>
						</section>
	
						<section>
							<h3>Outline</h3>
							<ul>		
								<li>Prepare environment (ex-2)</li>
								<li>Environment Variables</li>
								<li>Explore the web app code</li>
								<li>Config, run and explore app</li>
								<li>Secrets</li>
								<li>Staging environments and logging</li>
							</ul>
						</section>

						<section>
							<h3>Preparing the environment</h3>
							<ul>
								<li>Navigate to the <span style="color: blue">./ex-2</span> directory</li>
								<li>Install dependencies
									<code class="hljs">$ npm install</code>
								</li>
							</ul>
						</section>

						<section>
							<h3>Environment variables</h3>
							<ul style="font-size: 70%;">
								<li>Define environment variables
									<code class="hljs">$ export PORT=3000</code>
									<code class="hljs">$ export CLIENT_SECRET=[your secret]</code>
									<code class="hljs">$ export CLIENT_ID=[your client id]</code>
									<code class="hljs">$ export NODE_ENV=[production | developement | debug]</code>
								</li>
								<li><span style="color:red">Good practice</span>: 
									Move config into config files, potentially .env files (that are defined in .gitignore and/or kept outside version control, stored outside git). 
									 <br></br>The <a href="https://www.npmjs.com/package/dotenv" target="_blank"> dotenv module</a> is one option in the NodeJs world.	
								</li>
							</ul>
						</section>

						

						<section>
								<h3>Explore the code</h3>
								<ul>
									<li>Explore endpoints in <a href="https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview" target="_blank">Azure</a> for application object</li>
									<li>Explore application config objects </br>(authServer, client, scope) in  <span style="color:blue">./app.js</span></li>
									<li>Explore authentication code in <span style="color:blue">./app.js</span></li>
									<ul>
										<li>/authorize</li>
										<li>/callback</li>
									</ul>
									<li>This example uses basic auth for passing client credentials (remember to base64 encode)</li>
									<li>(This example uses the <span style="color: red">request</span> module - which is deprecated by February 2020)
									</br>
									<li>Explore routing/views in application</li>
								</ul>
						</section>

						<section>
								<h3>Config, Run and Explore </h3>
								<img src="./graphics/export/actors.jpg" 
								style="
									position: absolute;
									top: 100px;
									right:0px;
									width:20%;
									display:inline-block
								">
								<ul style="font-size: 80%;">
									<li>Configure the <span style="color:blue">authServer</span> object in app.js</li>
									<li>Explore the <span style="color:blue">client</span> object in app.js</li>
									<li>Configure environment variables</li>
									<lI>Verify the app object in Azure AD </br>(Hint: redirect URI's)</lI>
									<li>Run web application
										<code class="hljs">$ npm start</code>
									</li>
									<li>Explore <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-auth-code-flow" target="_blank">spec</a>, alter scope and other params</li>
									<li>Explore what <a href="https://myapps.microsoft.com/" target="_blank">consent</a> you have given to apps on Azure AD. 
									</br> Test revoking for test app.</li>
									<li>Explore running the app with NODE_ENV=debug</li>
									<li><span style="color:red">Bad practice</span>: 
										Extracting things like "given_name" from Access Token to display in client (as done in exercise code)</li>
								</ul>
								</ul>
						</section>

						<section>
							<h3>Secrets</h3>
							<ul>
								<li><span style="color:red">Good practice</span>: 
									Keep secrets outside version control!	
								</li>
								<li><span style="color:red">Ok practice</span>: 
									Inject secrets as environment variables	
								</li>
								<li><span style="color:red">Good practice</span>: 
									Store secrets in keyvaults (explore if managed identities are available (MSI)) 	
								</li>
							</ul>
						</section>

						<section>
							<h3>Staging environments - logging </h3>
							<ul>
								<li>Explore logging logic in <span style="color:blue">./app.js</span></li>
								<li>Different logging level dependent on environment (debug, development, production)</li>
								<li><span style="color:red">Good practice</span>: 
									Have a strategy for log purpose and transports (why you log, where you store/not store)	
								</li>
								<li><span style="color:red">Good practice</span>: 
									Be conscious of what you put in log files!!	
								</li>
							</ul>
						</section>
				</section>

<!-- The basic of A&A - part 2 -->
<section>
	<section>
		<h1>The basics of A&A</h1>
		<h4>Part #2</h4>
	</section>


	<section>
		<h2>Let's disucss a few elements</h2>
	</section>


	<section>
			<h3>Clients</h3>
			<ul>
				<li>Clients are either confidential or public
					<ul>
						<li><span style="color:red">Confidential:</span> Clients capable of maintaining the confidentiality of their credentials. (Web apps)</li>
						<li><span style="color:red">Public:</span> Clients incapable of maintaining the confidentiality of their credentials (SPA, Native) </li>
					</ul>
				</li>
				<li>Clients provide a redirection URI</li>
			</ul>
		</section>
	
		<section>
			<h3>Protocol Endpoints</h3>
			<ul>
				<br><span style="color:red">Authorization endpoint:</span> used by client to get authorization from resource owner,</br>user is involved - delegation </li>
				<li><span style="color:red">Token endpoint:</span> used by client to exchange authorization grant for an access token</li>
				<li>There may be other endpoints based on specific implementation, OICD has a few more as well.</li>
		</section>
		
		<section>
			<h3>Channels - Interaction between actors</h3>
			<ul>
				<li><span style="color:red">Front-channel</span>: Communication between two parties through an intermediate (the web browser)</li>
				<li><span style="color:red">Back-channel</span>: Communication happening outside the view of the resource owner and the user agent (like browser)</li>					
			</ul>

		</section>


		<section>
			<h2>Tokens</h2>
			<ul>
				<li>Token type: How it can be used</li>
				<ul>
					<li>Use it as is, bearer type (Access token) (<a href="https://tools.ietf.org/html/rfc6750" target="_blank">RFC6750</a>)  </li>
					<li>Use it, but prove that I own it </br>(Proof Of Possession)(No wide implementation)</li>
				</ul>
				<li>Token format: Encoding</li>
				<ul>
					<li>By value (token contains all values)</li>
					<li>By reference (pointer to more information)</li>
				</ul>
				<li>Token purpose: Who is it for?</br>(Client, Authorisation Server, Resource Server</li>
			</ul>
		</section>

		<section>
			<h3>Access token</h3>
			<ul style="font-size: 80%;">
				<li>Access tokens are credentials used to access protected resources.  An access token is a string representing an authorization issued to the	client. 
					The string is usually opaque to the client.
					Tokens represent specific scopes and durations of access,
					granted by the resource owner (or admin), and enforced by the resource server and authorization server.</span>
				 </li>
				 <li>By reference or value, for <span style="color:red">resource server</span>, bearer type</li>
			</ul>						
		</section>

		<section>
				<h3>Refresh token</h3>
				<ul style="font-size: 80%;">
					<li>Refresh tokens are credentials used to obtain access tokens.  Refresh tokens are issued to the client by the authorization server and are used to obtain a new access token when the current access token becomes invalid or expires, or to obtain additional access tokens with identical or narrower scope (access tokens may have a shorter lifetime and fewer permissions than authorized by the resource	owner).  Issuing a refresh token is optional at the discretion of the authorization server.  If the authorization server issues a refresh token, it is included when issuing an access token.</span>
					</li>
					 <li>By value, for <span style="color:red">client</span></li>
				</ul>						
		</section>

		<section>
			<h3>ID token</h2>
			<ul style="font-size: 80%;">
				<li>ID tokens are issued to the client to validate that a user is who he/she claims to be and to provide additional
					information about the user.
				</li>
				<li>ID tokens are issued as part of OpenID connect</li>
				 <li>By value, for <span style="color:red">client</span></li>
			</ul>						
	</section>

	<section>
			<h3>Azure AD (AAD) issues JWT tokens (access, id)</h3>
			<small><a href="https://tools.ietf.org/html/rfc7519" target="_blank">JSON Web Token (JWT)(RFC7519)</a></small></br>
			<div style="font-size:40%; text-align: center;">eyJ0eXAiOiJKV1QiLA0KICJhbGciOiJIUzI1NiJ9<span style="color:red">.</span></br>eyJpc3MiOiJqb2UiLA0KICJleHAiOjEzMDA4MTkzODAsDQogImh0dHA6Ly9leGFtcGxlLmNvbS9pc19yb290Ijp0cnVlfQ<span style="color:red">.</span></br>dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk</div>
			<p></p>
			<pre><code class="hljs">
{
"typ": "JWT",
"alg": "HS256"
}.
{
"iss": "joe",
"exp": 1300819380,
}.
[Signature]
			</code> 
			</pre>	
			<small style="font-size: 40%;">Header, Payload with claims and Signature -  based64 encoded</small>

		</section>


		<section>
			<h3>Example ID Token</h3>
			<small>Azure AD ID Token <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/id-tokens" target="_blank">claims</a></small>
			<pre><code class="hljs" style="font-size: 60%;">
{
"typ": "JWT",
"alg": "RS256"
}.{
"aud": "cab2507d-e7d1-46fd-9580-ea7de0cd02ea",
"iss": "https://login.microsoftonline.com/../v2.0",
"exp": 1571657734,
"name": "Jon Doe",
"oid": "..",
"roles": [
"Admin"
],
"sub": "..",
}.[Signature]</code> 
			</pre>	
		</section>

	<section>
		<h3>Scope</h3>
		<ul>
			<li>Defined the scope of access</li>
			<li>Defines permissions given in the access token</li>
			<li>Consentable</li>
			<li>The scope request is configured on the client</li>
			<li>The Scope is requested in the flow</li>
			<li>The Authorization Server determines if scope should be issued</li>
		</ul>
	</section>
	<section>
			<h3>Consent</h3>
			<ul>
				<li>Scope can be consented by (In Azure impl)</li>
				<ul>
					<li>User on on-behalf of self</li> 
					<li>Admin on behalf of organization</li>
				</ul>
				<li>The consent is about delegating the client access to resource server on a users behalf</li>
			</ul>
		</section>


		<section>
			<h3>Token Introspection</h3>
			<ul>
				<li>The process for a protected resource to query the authorization server to verify validity of a oAuth2 token</li>
				<li>An extension to oAuth2 defined in <a href="https://tools.ietf.org/html/rfc7662"
				target="_blank">rfc7662</a></li>
				<li>Getting tokens type by ref and querying for "details"</li>
				<li>Not currently supported by Azure AD
				<a href="https://feedback.azure.com/forums/169401-azure-active-directory/suggestions/18930289-introspection-endpoint-for-azure-active-directory"
				target="_blank">(Improvement request)</a>	
				</li>
			</ul>
		</section>

	
</section>



<!-- Exercise 3 :  -->	
					<section>
							<section>
								<h1>Exercise 3</h1>
								<h3>Scope</h3>
								<small>Consent, Graph explorer, tokens - security, state - session</small>
							</section>

							<section>
									<h3>Outline</h3>
									<ul>
										<li>Explore the MS Graph Explorer</li>
										<li>Discuss Permissions and Consent</li>
										<li>Prepare environment (ex-3)</li>
										<li>Explore the code</li>
										<li>Config, run and explore</li>
										<li>Security considerations - good practices++</li>
									</ul>
							</section>
	
							<section>
								<h3>The MS Graph Explorer</h3>
								<ul>
									<li>Open the <a href="https://developer.microsoft.com/en-us/graph/graph-explorer"
									target="_blank">MS Graph Explorer</a></li>
									<li>Sign in</li>
									<li>Query the <span style="color:blue">/v1.0/me</span> endpoint</li>
									<li>Query the <span style="color:blue">/v1.0/me/memberOf</span> endpoint</li>
									<li>Query the <span style="color:blue">v1.0/me/mailFolders('Inbox')/messages?$select=sender,subject</span> endpoint</li>
									<li>Explore the <a href="https://docs.microsoft.com/nb-no/graph/api/overview?view=graph-rest-1.0" target="_blank">graph api</a> documentation</li>
									<li>Play around with other endpoints, filtering, permissions, consent</li>
								</ul>
							</section>		

							<section>
								<h3>Permissions & Consent</h3>
								<ul style="font-size: 80%;">
									<li><a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-permissions-and-consent" target="_blank">Documentation</a> of Permission and Consent on the MS Identity platform </li>
									<li>Scope = requested permissions</li>
									<li>Delegated permissions, for signed-in-user, user or admin consent</li>
									<li>Application permission, without signed-in-user, admin consent only</li>
									<li>Effective permissions - least privileged between app and user (Example App has User.ReadWriteAll, User has no admin right = Effective rights will be only to update own profile)  </li>
									<li>Effective permission for application permission will be the full permission</li>
								</ul>
							</section>

							<section>
									<h3>Preparing the environment</h3>
									<ul>
										<li>Navigate to the <span style="color: blue">./ex-3</span> directory</li>
										<li>Install dependencies
											<code class="hljs">$ npm install</code>
										</li>
									</ul>
							</section>

							<section>
									<h3>Explore the code</h3>
									<ul>
										<li>Explore authentication code in <span style="color:blue">./app.js</span></li>
										<li>Adding new route to show mail (/routes/mail.js)</li>
										<li>Adding capabilities to scope (Mail.Read)</li>
										<li>Storing access_token in session</li>
										<li>Explore routing/views in application (<span style="color:blue">app.use('/mail', mailRouter);</span>)</li>
									</ul>
							</section>

							<section>
									<h3>Config, Run and Explore </h3>
									<img src="./graphics/export/actors.jpg" 
									style="
										position: absolute;
										top: 150px;
										right:0px;
										width:20%;
										display:inline-block
									">
									<ul>
										<li>Explore the <span style="color:blue">authServer</span> object in app.js</li>
										<li>Explore the <span style="color:blue">client</span> object in app.js</li>
										<li>Configure environment variables</li>
										<li>Run web application
											<code class="hljs">$ npm start</code>
										</li>
										<li>Explore the new mail functionality</li>
									</ul>
							</section>


							<section>
									<h3>Security considerations</h3>
									<ul style="font-size: 80%;">
										<li>Access_token storage</li>
										<li>Increase user experience - extend session management to persist user data, refresh tokens??</li>
										<li>Access_token validation - is not happening</li>
										<li><a href="https://tools.ietf.org/html/rfc6819" target="_blank">oAuth2 Threat Model and Security Considerations</a></li>
										<li><a href="https://tools.ietf.org/html/draft-ietf-oauth-security-topics" target="_blank"> OAuth Security Topics</a></li>
										<li><span style="color:red">Good practice</span>: 
											It's a lot of hard work to get A&A done properly - USE a Framework!
										</li>
										<li><span style="color:red">Good practice</span>: 
											Protocols (and Frameworks) does not guarantee security, Developers Do
										</li>
										<li><span style="color:red">Good practice</span>: 
											Only request the minimum scope, dynamically - not all at once
										</li>
									</ul>
								</section>
						</section>
<!-- Exercise 4 :  -->						
					<section>
							<section>
								<h1>Exercise 4</h1>
								<h3>Use frameworks!</h3>
							</section>

							<section>
									<h3>Outline</h3>
									<ul>
										<li>Explore available frameworks for oAuth2</li>
										<li>Prepare environment (ex-4)</li>
										<li>Explore the code</li>
										<li>Config, run and explore</li>
										<li>Font-end vs. back-end communication channels</li>
										<li>Session handling</li>
										<li>Security considerations - good practices++</li>
									</ul>
							</section>

							<section>
								<h3>Frameworks</h3>
								<ul>
									<li>Explore the <span style="color:blue">quickstart</span> of the application object</li>
									<li>Explore <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/reference-v2-libraries"
										target="_blank">Authentication libraries</a> at the MS Identity Platform</li>
									<li>Explore <a href="https://oauth.net/code/"
											target="_blank">Authentication libraries</a> at oauth.net</li>
									<li>Explore <a href="https://github.com/AzureADQuickStarts"
												target="_blank">the Azure AD Quick Starts</a></li>		
									<li><span style="color:red">Good practice</span>: 
										Use the latest library from Microsoft, MSAL, when available
									</li>	
								</ul>
							</section>

							<section>
									<h3>Preparing the environment</h3>
									<ul>
										<li>Navigate to the <span style="color: blue">./ex-4</span> directory</li>
										<li>Install dependencies
											<code class="hljs">$ npm install</code>
										</li>
									</ul>
							</section>

							<section>
									<h3>Explore the code</h3>
									<ul>
										<li>Introducing <a href="http://www.passportjs.org/" target="_blank">passport.js</a></li>
										<li>Introducing <a href="https://github.com/AzureAD/passport-azure-ad" target="_blank">passport-azure-ad</a></li>
										<li style="color:blue">config/config.js</li>
										<li>./src/</li>
										<ul>
											<li style="color:blue">app.js</li>
											<li>authutils.js</li>
											<li>logHelper.js</li>
										</ul>
										<li>./routes/</li>
										<ul>
												<li>index.js</li>
												<li>mail.js</li>
												<li>userinformation.js</li>
											</ul>
									</ul>
							</section>

							<section>
									<h3>Config, Run and Explore </h3>
									<img src="./graphics/export/actors.jpg" 
									style="
										position: absolute;
										top: 150px;
										right:0px;
										width:20%;
										display:inline-block
									">
									<ul>
										<li>Update the AD application object with new <span style="color:blue">redirect url</span></li>
										<li>Configure environment variables</li>
										<li>Run web application
											<code class="hljs">$ npm start</code>
										</li>
										<li>Explore the application</li>
										<li>Change "node_env" and observe whats happening to the logging</li>
									</ul>
							</section>

							<section>
								<h3>Font-end vs. back-end com. channels</h3>
								<img src="./graphics/export/actors.jpg" 
									style="
										position: absolute;
										top: 130px;
										right:0px;
										width:30%;
										display:inline-block
									">
								<ul>
									<li>Font-end: Browser (User agent) to</li>
									<ul>
										<li>back-end (localhost:3000/mail,</br> /userinfo)</li>
										<li>Azure AD authentication</li>
									</ul>
									<li>Back-end: Client (Web app) to</li>
									<ul>
										<li>Azure ADd authorize (getting access token)</li>
										<li>Accessing the MS Graph on behalf of user</li>
									</ul>
									<li>A tool like <a href="https://portswigger.net/burp/communitydownload" target="_blank">Burp Community Edition</a>
										could be used to investigate/debug front-end and back-end traffic when on localhost
										<small>Browsers may have different policies on using proxies for localhost</small>
									</li>
								</ul>
								</section>

								<section>
										<h3>Session handling</h3>
										<ul style="font-size: 80%;">
											<li>We are using OIDC and the ID TOKEN as proof of authentication and to drive the user experience/mgmt in our app</li>
											<li>OICD offloads a lot of user management for our app</li>
											<li>Our web application use express and <a href="https://github.com/expressjs/session" target="_blank">express-session</a> to manage user session</li>
											<li>The session cookie is named connect.sid</li>
											<li>The cookie only stores session id</li>
											<li>The cookie is signed (to detect tampering)</li>
											<li>Session data is stored on the back-end (memory, not recommended for production)</li>
											<li><span style="color:blue">Task:</span> Open the developer tools in the browser and locate the session cookie for our app.
												Alter cookie and observe effect in app </li>
										</ul>
										</section>	

							<section>
									<h3>Security considerations</h3>
									<ul style="font-size: 80%;">
										<li>Token storage</li>
										<li>Persistent Session storage (from memory to database?)</li>
										<li>Cookie signing keys</li>
										<li>Cookie stealing</li>
										<li>Access_token is being validated</li>
										<li>Only authenticated users are getting access to end-points (<span style="color:blue">ensureAuthenticated</span>)</li>
											<li><span style="color:red">Good practice</span>: 
											Follow security advices for all frameworks (Example:  
											<a href="https://expressjs.com/en/advanced/best-practice-security.html" target="_blank">Express - Production Best Practices: Security</a>)</li>
											<li><span style="color:red">Good practice</span>: 
												Know your frameworks - it takes time & capacity when complexity is hidden!  
												</li>
										</ul>
								</section>
					</section>

<!-- Exercise 5 :  -->	
					<section>
							<section>
								<h1>Exercise 5</h1>
								<h3>Authorization scenarios</h3>
								<h4>The Application Manifest</h4>
							</section>

							<section>
								<h3>Outline</h3>
									<ul style="font-size: 80%;">
										<li>Prepare environment (ex-5)</li>
										<li>Explore the code</li>
										<li>Config, run and explore</li>
										<li>Scenario 1: Only people with valid account should have access</li>
										<li>Scenario 2: Only defined users/groups should have access</li>
										<li>Scenario 3: Application roles to handele authorisation</li>
										<li>Accessing 3d party api's protected by oauth2</li>
									</ul>
							</section>

							<section>
									<h3>Preparing the environment</h3>
									<ul>
										<li>Navigate to the <span style="color: blue">./ex-5</span> directory</li>
										<li>Install dependencies
											<code class="hljs">$ npm install</code>
										</li>
										</ul>
							</section>

							<section>
									<h3>Explore the code</h3>
									<ul>
										<li style="color:blue">src/app.js</li>
											<ul>
												<li>passport.use(....)</br>Creating authInfo object in profile to store relevant claims</li>
											</ul>
											<li style="color:blue">view/userinfo.pug</li>
											<ul>
												<li>Showing information about groups & roles in claim</li>
											</ul></br>
									</ul>
							</section>

							<section>
								<h3>Exploring claims in tokens</h3>
								<pre><code class="hljs">
{...}.
{...
 "name": "Jon Doe",
 "preferred_username": "",
 "roles": [
	"Writer"
 ],
 "groups": ["",""],
}.[Signature]
								</code></pre>
								Explore <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/id-tokens" target="_blank">
								 ID Tokens</a> and 
								 <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/access-tokens" target="_blank"> Acess Tokens</a> and  in MS Identity platform as well as the <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-optional-claims"
								 target="_blank">optional</a> claims (and the new <b>token configuration</b> in the AD app object).
								<p>(Claims does not always show up in the token you expect. OIDC drives some claims into the ID token)</p>
								</section>

							<section>
									<h3>Config, Run and Explore </h3>
									<img src="./graphics/export/actors.jpg" 
									style="
										position: absolute;
										top: 200px;
										right:0px;
										width:20%;
										display:inline-block
									">
									<ul>
										<li>Verify the AD application object <span style="color:blue">redirect url</span></li>
										<li>Configure environment variables</li>
										<li>Run web application
											<code class="hljs">$ npm start</code>
										</li>
										<li>Explore the "user information" part of the web application</li>
									</ul>
							</section>

							<section>
								<h3>Scenario 1:</br> Only people with a valid account should have access</h3>
								<ul style="font-size: 80%;">
									<li><span style="color:blue">App Registration (object)</span> vs. <span style="color:blue">Enterprise Application (instance, multi-tentant)</span></li>
									<li>In "Enterprise Applications" (Azure AD) explore the property section for your application</li>
									<ul>
										<li>"Enables for users to sign-in?"</li>
										<li>"User assignment required?"</br>(User must be assigned to be able to sign in)</li>
									</ul>
									<li><span style="color:blue">Sign-in enabled</span> and <span style="color:blue">no user assignment required = available to everyone with valid user account in tenant</li>
								</ul>
								</section>

							<section>
									<h3>Scenario 2:</br> Only defined users/groups should have access</<br></h3>
									<ul style="font-size: 65%;">
										<li>There are several ways to achive this scenario</li>
										<li>1) Managing the App Object</li>
											<ul>
												<li>Set "User assignment" to "Yes" - in App property</li>
												<li>Add users and groups in "Users & Groups" - in App property</li>
											</ul>
										<li>2) Alter application manifest to include security groups</li>
										<ul>
											<li>The <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/reference-app-manifest" target="_blank">Application Manifest</a> defines all the attributes and behavior of an applicaton object</li>
											<li><span style="color:blue">groupMembershipClaims</span> to include <span style="color:blue">"SecurityGroup"</span></li>
											<li>Alter - save - explore "user information part in our web app</li>
											<li>This approach have some limitations (size) </li>
										</ul>
										<li>3) Read information in the Microsoft graph about user & groups. 
											This require admin concent for the application and generally gives to much privileges!! Should be avoided</li>
									</ul>
								</section>

								<section>
										<h3>Scenario 3: Application roles</h3>
										<ul style="font-size: 65%;">
											<li>Application roles implement RBAC</li>
											<li>App admins grant permissions to roles, users and groups are assigned to roles</li>
											<li>Define application role in app manifest (<a href="https://docs.microsoft.com/nb-no/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps" target="_blank">doc</a>)
											</br>ID is a self generated GUID and must be unique
											(<a href="https://guidgenerator.com/" target="_blank">Online GUID Generator</a>)</li>	
											<pre><code class="hljs">
"appRoles": [
{
  "allowedMemberTypes": ["User"],
  "displayName": "Writer",
  "id": "b421319c-3e45-4685-aaf2-b1282ad05a6f",
  "isEnabled": true,
  "description": "Writers Have the ability to create tasks.",
  "value": "Writer"
}
],
"availableToOtherTenants": false,
											</code></pre>		
										<li>Alter manifest with "Writer" app role". Save</li>
										<li>Assign a user or group to the "Write roles" in "Enterprise apps" - "Users and Groups"</li>			
										<li>Explore the "User information" part of our web app</li>				
										</ul>
									</section>
	
									<section>
										<h3>Accessing 3d party api's protected by oAuth2</h3>
										<ul style="font-size: 70%;">
											<li>Add/Include api resource to scope</li>
											<li>Hit token endpoint to request an access token</li>
											<li>Use access token to access api</li>
											<li>Explore the mail part of our web application (/routes/mail.js)</li>
											<li>Explore Static vs. Dynamic permissions</li>
											<ul>
												<li><a href="https://docs.microsoft.com/nb-no/azure/active-directory/develop/v2-permissions-and-consent" target="_blank">Permissions and Consent in MS Identity</a></li>
												<li>Change scope to include <span style="color:blue">
													https://graph.microsoft.com/Contacts.read</span> from code (scope config) and/or "api permissions" in app definition (AD) </li>
												<li>Remember to restart app after changes (and do a new login)</li>
												<li>Add other resources from the MS Graph Explorer and observe consent flow</li>
											</ul>
										</ul>
									</section>
					</section>

<!-- Exercise 6 :  -->	
					<section>
							<section>
								<h1>Exercise 6</h1>
								<h3>Refresh tokens</h3>
							</section>

							<section>
								<h3>Outline</h3>
								<ul>
								<li>What are refresh tokens?</li>
								<li>Framework support for handling refresh</li>
								<li>Prepare environment (ex-6)</li>
								<li>Explore the code</li>
								<li>Config, run and explore</li>
							</ul>
							</section>

							<section>
								<h3>What are refresh tokens?</h3>
								<ul style="font-size: 80%;">
									<li><a href="https://tools.ietf.org/html/rfc6749#section-1.5"
										target="_blank">rfc6749 section 1.5</a>,
										<a href="https://tools.ietf.org/html/rfc6749#section-6"
										target="_blank">rfc6749 section 6 for refresh access token</a>
									</li>
									<li>"Refresh tokens are credentials used to obtain access tokens."</li>
									<li>Are used to get new access token when current one expire</li>
									<li>Are used to get new access token to narrow scope</li>
									<li>Refresh tokens are issued by the authorization server and are never used by resource servers</li>
									<li>Refresh tokens is only issued to secure clients
									</br>(Not supported by implicit flow)</li>
									<li>Refresh tokens can be stored on back-end to perform operations on behalf of user when not logged in</li>
									<li>Refesh tokens are quite often about user experience </br>(log-in experience)</li>
								</ul>
							</section>

							<section>
								<h3>Framework support for handling refresh</h3>
								<ul>
									<li>Framework support for automatic handling of refresh tokens is varying</li>
									<li>Verify support in each framework</li>
									<li><a href="https://docs.microsoft.com/nb-no/azure/active-directory/develop/msal-authentication-flows#how-each-flow-emits-tokens-and-codes"
										target="_blank">Flows</a> that emits refresh tokens in Azure</li>
									<li>Single Page Web applications using MSAL.JS usually do a silent login-and-get-new tokens to the user due to no refresh token</li>
									<li>The framework we use, Passport.js, does not have native support for refresh tokens. So lets add it :)
									</ul>
							</section>

							<section>
									<h3>Preparing the environment</h3>
									<ul>
										<li>Navigate to the <span style="color: blue">./ex-6</span> directory</li>
										<li>Install dependencies
											<code class="hljs">$ npm install</code>
										</li>
										</ul>
							</section>

							<section>
									<h3>Explore the code</h3>
									<ul style="font-size:70%">
										<li style="color:blue">config/config.js</li>
											<ul>
												<li>Scope param includes "offline_access" which emits refresh token</li>
												<li>"diffSecondsBeforeRefresh" (ExpireTime - NowTime <= diffSecondsBeforeRefresh)</li>
											</ul>
											<li style="color:blue">src/app.js</li>
											<ul>
												<li>Storing refresh-token in authinfo object</li>
												<li>Middleware (considerRefresh) to determine if we should get new access tokens</li>
											</ul>
											<li style="color:blue">src/authutils.js</li>
											<ul>
												<li>"considerRefresh" function which does the magic</li>
												<li>We refresh based on time (in seconds) before expire</li>
												<li>We could also react to the 401 issued by Azure AD when we try to use and expired access token </li>
												<li>(It's worth knowing that java script stores time in milliseconds while it's seconds int the tokens)</li>
											</ul>
									</ul>
							</section>

							<section>
									<h3>Config, Run and Explore </h3>
									<img src="./graphics/export/actors.jpg" 
									style="
										position: absolute;
										top: 100px;
										right:0px;
										width:20%;
										display:inline-block
									">
									<ul style="font-size: 80%;">
										<li>Verify the AD application object <span style="color:blue">redirect url</span></li>
										<li>Configure environment variables</li>
										<li>Run web application
											<code class="hljs">$ npm start</code>
										</li>
										<li>Explore the "user information" part of the web application</li>
										<li>Explore changing the "diffSecondsBeforeRefresh" config and observe token refresh (by expire date and in log)</li>
										<li>Observer that we get a new access token with the refresh, but the "old" one is still valid</li>
									</ul>
							</section>
					</section>
					
<!-- Exercise 7 :  -->	
					<section>
							<section>
								<h1>Exercise 7</h1>
								<h3>Single Page Web Application (SPA)</h3>
								<small>Implicit grant flow </small>
							</section>

							<section>
								<h3>Outline</h3>
								<ul>
									<li>What is a SPA?</li>
									<li>Implicit grant</li>
									<li>Prepare environment (EX-7)</li>
									<li>Explore code</li>
									<li>Config, Run and Explore</li>
									<li>Security considerations</li>
								</ul>
							</section>

							<section>
								<h3>What is a SPA?</h3>
								<img src="./graphics/export/actors.jpg" 
									style="
										position: absolute;
										top: 300px;
										right:0px;
										width:30%;
										display:inline-block
									">
								<ul>
									<li><a href="https://en.wikipedia.org/wiki/Single-page_application"
										target="_blank">SPA</a> = Single Page Application</li>
									<li>Re-Writing DOM rather than refreshing page</li>
									<li>1) Web browser (user agent) only </br>(all communications happens
										</br> in browser, client is in browser)</li>
									<li>2) Hybrid, web communicates </br>to dedicated back-end (client)</br> which then handles external</br> communication</li>
								</ul>
							</section>

		
							<section>
								<h4>oAuth2 Implicit Grant</h4>
								<small><a href="https://tools.ietf.org/html/rfc6749#section-4.2" target="_blank">rfc6749 #4.2</a></small>
								<pre style="font-size: 30%;">
		+----------+
		| Resource |
		|  Owner   |
		|          |
		+----------+
			 ^
			 |
			(B)
		+----|-----+          Client Identifier     +---------------+
		|         -+----(A)-- & Redirection URI --->|               |
		|  User-   |                                | Authorization |
		|  Agent  -|----(B)-- User authenticates -->|     Server    |
		|          |                                |               |
		|          |<---(C)--- Redirection URI ----<|               |
		|          |          with Access Token     +---------------+
		|          |            in Fragment
		|          |                                +---------------+
		|          |----(D)--- Redirection URI ---->|   Web-Hosted  |
		|          |          without Fragment      |     Client    |
		|          |                                |    Resource   |
		|     (F)  |<---(E)------- Script ---------<|               |
		|          |                                +---------------+
		+-|--------+
		  |    |
		 (A)  (G) Access Token
		  |    |
		  ^    v
		+---------+
		|         |
		|  Client |
		|         |
		+---------+			   			  	
		Client lives inside browser (user agent)						
								</pre>
							</section>
		
							<section>
								<h3>oAuth2 Implicit Flow</h3>
								<table>
									<tr>
										<td><img src="./graphics/export/oauth_implicit_flow.jpg" ></td>
										<td style=" vertical-align: top;">
											<p>-2-</p>
											<span style="font-size: 70%;">
											GET /<span style="color:red">authorize</span>? </br>
											client_id=client </br>
											&scope=user.read</br>
											&reponse_type=<span style="color:red">token</span></br>
											&state=1234</br>
											&redirect_uri=</br>
											https://app/callback</span>
											</span>
										</td>
									</tr>
								</table>
						</section>
	
	
						<section>
								<h3>oAuth2 Implicit Flow</h3>
								<table>
									<tr>
										<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
										<td style=" vertical-align: top;">
											<p>-3-</p>
											Authentication is handed over to authentication server
										</td>
									</tr>
								</table>
						</section>
	
						<section>
								<h3>oAuth2 Implicit Flow</h3>
								<table>
									<tr>
										<td><img src="./graphics/export/oauth_implicit_flow.jpg" ></td>
										<td style=" vertical-align: top;">
											<p>-4-</p>
											<span style="font-size: 70%;">
											303 redirect
											https://app/callback? </br>
											
											Fragment: #</br>
											access_token=AT</br>
											expires_in=3600</br>
											token_type=Bearer</br>
											&state=1234	
											</span>
										</td>
									</tr>
								</table>
						</section>
	

				
							<section>
									<h3>OpenID Connect Implicit Flow</h3>
									<p>(for comparison)(<a href="https://openid.net/specs/openid-connect-core-1_0.html#ImplicitFlowAuth" target="_blank">spec</a>)</p>
									<table>
										<tr>
											<td><img src="./graphics/export/oauth_implicit_flow.jpg" ></td>
											<td style=" vertical-align: top;">
												<p>-2-</p>
												<span style="font-size: 70%;">
												GET /authorize? </br>
												client_id=client </br>
												&scope=<span style="color:red">openid</span></br>
												&reponse_type=<span style="color:red">id_token</span></br>
												&state=1234</br>
												&<span style="color:red">nonce=a_nonce</span></br>
												&redirect_uri=</br>
												https://app/callback</span>
												</span>
											</td>
										</tr>
									</table>
							</section>
		
		
							<section>
									<h3>OpenID Connect Implicit Flow</h3>
									<table>
										<tr>
											<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
											<td style=" vertical-align: top;">
												<p>-3-</p>
												Authentication is handed over to authentication server
											</td>
										</tr>
									</table>
							</section>
		
							<section>
									<h3>OpenID Connect Implicit Flow</h3>
									<table>
										<tr>
											<td><img src="./graphics/export/oauth_implicit_flow.jpg" ></td>
											<td style=" vertical-align: top;">
												<p>-4-</p>
												<span style="font-size: 70%;">
												303 redirect
												https://app/callback? </br>
												
												Fragment: #</br>
												id_token=IDT</br>
												expires_in=3600</br>
												token_type=Bearer</br>
												&state=1234</br>
												&nonce=a_nonce	
												</span>
											</td>
										</tr>
									</table>
							</section>
		

							<section>
									<h3>Preparing the environment</h3>
									<ul>
										<li>Navigate to the <span style="color: blue">./ex-7</span> directory</li>
										<li>Install dependencies
											<code class="hljs">$ npm install</code>
										</li>
										</ul>
							</section>

							<section>
								<h3>Explore the code</h3>
								<img src="./graphics/export/actors.jpg" 
									style="
										position: absolute;
										top: 280px;
										right:0px;
										width:20%;
										display:inline-block
									">
								<ul style="font-size: 80%;">
									<li>We use an <a href="https://github.com/Azure-Samples/active-directory-javascript-graphapi-v2"
									target="_blank">example</a> from microsoft, calling the graph api from javascript</li>
									<li>The example uses <a href="https://github.com/AzureAD/microsoft-authentication-library-for-js/wiki" 
										target="_blank">MSAL.JS</a> (v1). MSAL.JS may not support all modes for oAuth2 or OICD</li>
									<li>Our back-end serves the static web page</br> (and responds to redirects)(The hybrid)</li>
									<ul>
										<li><span style="color:blue">server.js</span> serves the static web page</li>
									</ul>
									<li>The application lives in the browser</li>
									<ul>
										<li><span style="color:blue">JavaScriptSPA/index.html</span></li<span>
									</ul>
								</ul>
							</section>

							<section>
								<h3>Config, Run and Explore</h3>
								<ul style="font-size: 80%;">
										<li>Update configuration in <span style="color:blue">javaScriptSPA/index.html:msalConfig</span> (clientid, authority)</li>
										<li>Configure AD app object (Azure AD)</li>
											<ul>
												<li>Redirect URI: http://localhost:3000</li>
												<li>Authentication:Advances Setting:Implicit grant - allow access token and ID tokens</li>	
											</ul>
										<li>Configure environment back-end variables (PORT)</li>
										<li>Run web application
											<code class="hljs">$ npm start</code>
										</li>
										<li>Explore SPA Client (Browser, Developer Mode)</li>
										<ul>
											<li>Network flow to graph api - headers</li>
											<li>Cookies</li>
											<li>Local storage</li>
										</ul>
									</ul>
							</section>

							<section>
									<h3>Security considerations</h3>
									<ul style="font-size: 80%;">
										<li>It's a public client!</li>
										<li>Implicit flow is less secure than code grant</li>
										<li>The redirect GET REQUEST exposes the AccessToken/Id_Token</li>
										<li>Information - like tokens are available to "everyone" using the browser</li>
										<li><span style="color:red">Good practice</span>: 
											Follow advice in OWASP Top 10 for Web application security (<a href="https://www.owasp.org/www-project-top-ten/" target="_blank">link</a>)</li>
											<li><span style="color:red">Good practice</span>: Always use HTTPS</li>
											<li><span style="color:red">Good practice</span>: Use Content Security Policy</li>
											<li><span style="color:red">Good practice</span>: Go with auth code grant flow if you can :)</li>
											<li><span style="color:red">Good advice</span>: Use MSAL v2. ADAL (v1) will be deprecated June 30th 2022 </li>	
										</ul>
								</section>
					</section>


<!-- Exercise 8 :  -->	
					<section>
						<section>
							<h1>Exercise 8</h1>
							<h3>SPA - PKCE</h3>
							<small>Code flow for public clients using PKCE</small></br>
							<small>Lower the risk of stolen the one time code</small>
						</section>

						<section>
							<h3>Outline</h3>
							<ul>
								<li>What is a PKCE?</li>
								<li>The code flow with PKCE</li>
								<li>Prepare environment (EX-8)</li>
								<li>Explore code</li>
								<li>Config, Run and Explore</li>
								<li>Security considerations</li>
							</ul>
						</section>

						<section>
							<h3>What is PCKE(Pixie)?</h3>
							<ul>
								<li>
									Proof Key for Code Exchange</br>- 
									<a href="https://tools.ietf.org/html/rfc7636" target="_blank">RFC 7636</a> - <a href="https://oauth.net/2/pkce/" 
									target="_blank">PKCE at oauth.net</a>
								</li>
								<li>"Replacing impclicit flow for public clients"</li>
								<li>Extension to Authorization code flow</li>
								<li>Using generated secret to avoid stealing of the one time authorization code</li>
							</ul>
						</section>
						<section>
							<h3>Elements of PCKE</h3>
							<p>For each request to get a token:</p>
							<ul>
								<li>Generate secret known as <span style="color:red">code verifier</span></li>
								<li>Code verifier is random generated secret.
									(A-Z, a-z, 0-9, and the punctuation characters -._~ (hyphen, period, underscore, and tilde), between 43 and 128 characters long.)</li>
								<li>Generate a <span style="color:red">code challenge</span>, SHA256 of code verifier - url encoded</li>
								<li>code_challenge_method to specific method of verifier - plain or s256</li>
							</ul>						
						</section>

						<section>
							<h3>Authorization Code Grant with PKCE</h3>
							<table>
								<tr>
									<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
									<td style=" vertical-align: top;">
										<p>-1-</p>
										Client via user agent - initiates
									</td>
								</tr>
							</table>
						</section>
		
						<section>
								<h3>Authorization Code Grant with PKCE</h3>
								<table>
									<tr>
										<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
										<td style=" vertical-align: top;">
											<p>-2-</p>
											<span style="font-size: 50%;">
												GET /authorize? </br>
												client_id=client </br>
												&scope=(optional) </br>
												&reponse_type=code </br>
												&state=1234 </br>
												&redirect_uri=
												https://app/callback 
												<span style="color:red">
												&code_challenge=(SHA of PKCE secret) </br>
												&code_challenge_method=S256
												</span>
											</span>
											</td> 
									</tr>
								</table>
						</section>
		
						<section>
								<h3>Authorization Code Grant with PKCE</h3>
								<table>
									<tr>
										<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
										<td style=" vertical-align: top;">
											<p>-3-</p>
											Authentication is handed over to authentication server
										</td>
									</tr>
								</table>
						</section>
		
						<section>
								<h3>Authorization Code Grant with PKCE</h3>
								<table>
									<tr>
										<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
										<td style=" vertical-align: top;">
											<p>-4-</p>
											<span style="font-size: 70%;">
											303 redirect
											https://app/callback? </br>
											code=o-t-c</br>
											&state=1234</br>		
											</span>
										</td>
									</tr>
								</table>
						</section>
		
						<section>
								<h3>Authorization Code Grant with PKCE</h3>
								<table>
									<tr>
										<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
										<td style=" vertical-align: top;">
											<p>-5-</p>
											<span style="font-size: 70%;">
											POST /token
											grant_type=authorization_code</br>
											&client_id=</br>
											<span style="color:red">
											&code_verfier=(the PKCE secret)</span></br>
											&code=</br>
											&redirect_uri=</br>
											</span>
										</td>
									</tr>
								</table>
						</section>
		
						<section>
								<h3>Authorization Code Grant with PKCE</h3>
								<table>
									<tr>
										<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
										<td style=" vertical-align: top;">
											<p>-6-</p>
											<span style="font-size: 70%;">
											{</br>
													"access_token":"2YotnFZFEjr1zCsicMWpAA",
													"token_type":"example",
													"expires_in":3600,
													"refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA",
													"token_type":"Bearer"
												</br>}
											</span>
										</td>
									</tr>
								</table>
						</section>
		
					<section>
							<h3>Preparing the environment - code</h3>
							<ul>
								<li>Navigate to the <span style="color: blue">./ex-8</span> directory</li>
								<li>Install dependencies
									<code class="hljs">$ npm install</code>
								</li>
							</ul>
					</section>

					<section>
						<h3>Preparing the environment - Azure AD</h3>

						<ul style="font-size:85%">
							<li>The MS identify platform support PKCE.</br> MSAL.JS v2 supports PKCE.
							</li>
							<li> For the app object (clientid) in Azure AD we need to</li>
							<ul>
								<li>Treat the web app as a public client (app reg -> Authentication -> Advanced Settings - Default Client Type = Yes), </li>
								<li>Add new platform "SPA" from "Authorization" - add redirect URI for app (http://localhost:3000/callback</li>
								<li>(Alternatively: Alter manifest in the "replyUrlsWithType" section, change "type" to "Spa" for the redirect urls that will use PKCE)</li>
							</ul>
							<li>The token request must use CORS - origin in the header </li>
						</ul>
				</section>

					<section>
						<h3>Explore the code</h3>
						<img src="./graphics/export/oauth_code_flow.jpg" 
							style="
								position: absolute;
								top: 280px;
								right:0px;
								width:20%;
								display:inline-block
							">
						<ul style="font-size: 80%;">
							<li>Same code as for exercise 2</li>
							<li><span style="color:blue">app.js</span> contains the web app</li>
							<li>Use node module "pkce-challenge" to generate code_verifier and code_challenge</li>
							<li>Alter query string for GET code request</li>
							<li>Alter header and body for POST to get token</li>
							<li>Add "origin" header for token request</li>
							<li>Removed the "client_secret" part</li>
							<li>This flow now supports refresh tokens for "public clients"</li>							
						</ul>
					</section>

					<section>
						<h3>Config, Run and Explore </h3>
					
						<ul style="font-size: 90%;">
							<li>Verify the <span style="color:blue">authServer</span> object in app.js</li>
							<li>Verify the <span style="color:blue">client</span> object in app.js</li>
							<li>Configure environment variables</br> (client_id)</li>
							<li>Run web application
								<code class="hljs">$ npm start</code>
							</li>
						</ul>
					</section>

					<section>
						<h3>Security Considerations</h3>
						<ul>
							<li>Security consideratins from <a href="https://tools.ietf.org/html/rfc7636#section-7" target="_blank">
							RFC 7636</a></li>
							<li>The implicit grant will most likely be deprecated in the future with oAuth 2.1</li>
							<li>MSAL.js v2.0 does not support the implicit grant</li>
							<li>I assume that using PKCE with code grant becomes mandatory at some point</li>
						</ul>
					</section>
					</section>

<!-- Exercise 9:  -->	
					<section>
							<section>
								<h1>Exercise 9</h1>
								<h3>Protecting web api's</h3>
								</br><small>AD App, Token validation</small>
								</br><small>Azure API GW - APIM</small>
							</section>

							<section>
								<h3>Outline</h3>
								<ul>
									<li>The scenario</li>
									<li>Add AD Application Object for API</li>
									<li>Explore and config the SPA code</li>
									<li>Explore and config the API code</li>
									<li>Run and Explore</li>
									<li>Security considerations</li>
								</ul>
							</section>

							<section>
								<h3>The scenario</h3>
								<img src="./graphics/export/api_scenario.jpg" >
									
							</section>

							<section>
								<h3>The Scenario</h3>
								<img src="./graphics/export/api_scenario.jpg" 
									style="
										position: absolute;
										top: 0px;
										right:0px;
										width:20%;
										display:inline-block
									">
								<ul>
									<li>Two components</li>
									<ul>
										<li>Single Page Web Application (from prev. exercise)</li>
										<li>API which echoes time</li>
									</ul>
									<li>New button in SPA to "Echo" api</li>
									<li>SPA sends request to API with access token as a bearer token</li>
									<li>API validates token and reponds with time if everything is ok</li>
								</ul>
							</section>

							<section>
								<h4>Adding Azure AD application object for API</h4>
								<ul style="font-size: 80%;">
									<li>Follow procedure in <a href="#/8/3" target="_blank">earlier exercise</a> to register API </li>
									<li>Activate "Application developer role" in "Privileged Identiy Management"</li>
									<li><span style="color:red">Name</span>: (inital)-(aa-echo-api) or something else</li>
									<li><span style="color:red">Type</span>: Single tenant</li>
									<li>Select "Expose an API" (app config)</li>
									<ul>
										<li>Add scope (accept suggested App ID URI)</li>
										<li>Scope name: Echo.Read</li>
										<li>Who can consent: Admins and Users (Add relevant text to descriptions)</li>
										<li>State: Enabled</li>
										<li>Remove "default" API permissions from API object (user.read)</li>
									</ul>
									</li>
								</ul>
							</section>

							<section>
								<h3>Explore and config the SPA code</h3>
								<ul style="font-size: 75%;">
									<li>Navigate to the <span style="color: blue">./ex-9/spa</span> directory</li>
									<li>Install dependencies <code class="hljs">$ npm install</code></li>
									<li>Update config in "JavaScriptSPA/index.html</li>	
									<li>Verify env. variables (PORT) and Azure AD App Config (redirect URI)</li>
									<ul>
										<li>msalConfig: clientId, authority(tenant id) (for SPA AD App)</li>
										<li>getEcho():requestEchoObj:scope (api://..../Echo.Read)</li>
										<li>getEcho(): Url to API (http://localhost:3100)</li>
									</ul>
									<li>The getEcho function do</li>
									<ul>
										<li>Request an access token to access the Echo API</li>
										<li>Call Echo with access token and then displays response</li>
									</ul>
									<li>Verify the config of the AD application object. It was most likely messed up in the previous exercise</li>
								</ul>
							</section>


							<section>
									<h3>Explore and config the API code</h3>
									<ul style="font-size:60%">
										<li>In a separate terminal - Navigate to the <span style="color: blue">./ex-9/api</span> directory</li>
										<li>Install dependencies <code class="hljs">$ npm install</code></li>
										<li>Update config in "bin/www (the port if needed)</li>	
										<li>Update config in "routes/index.js</li>
										<ul>
											<li>validateOptions: audience (the api app URI)</li>
											<li>validateOptions: issuer (the tenant id)</li>
										</ul>
										<li>Update config in "app.js" (corsOptions, will only accept requests from localhost. Must be changed if the SPA is moved)</li>
										<li>Code: "routes/index.js"</li>
										<ul>
											<li>Gets the api request, using 
												<a href="https://github.com/auth0/node-jsonwebtoken"
												target="_blank">library</a> to validate token</li>
											<li>"validateOptions" defines what will be validated</li>
											<li>Uses "well known endpoints" of API object to find keys++</li>
										</ul>
										<li>Code: "./app.js"</li>
										<ul>
											<li>The API middleware layer (Express)</li>
											<li>Define CORS headers using a <a href="https://github.com/expressjs/cors"
											target="_blank">library</a></li>
										</ul>
									</ul>
								</section>

								<section>
									<h3>Run and explore scenario</h3>
									<ul style="font-size: 90%;">
										<li>Use <span style="color:red">two</span> terminal sessions - SPA, API</li>
										<li>Navigate to the <span style="color: blue">./ex-9/api</span> and do
											<code class="hljs">$ npm start</code></li>
										<li>Navigate to the <span style="color: blue">./ex-9/spa</span> and do
											<code class="hljs">$ npm start</code></li>
										<li>Explore the new "Echo" functionallity</li>
										<li>Alter CORS headers and observe effect (in SPA - Dev mode</li>
										<li>Alter token validation options in API and observe effect</li>
										<li>Alter scope for Api in SPA and observe effect</li>
									</ul>
									
								</section>

								<section>
									<h3>Alternative solutions for chaining api</h3>
									</br>
									<ul>
										<li>The <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow"
											target="_blank">On-Behalf-Of</a> flow in the MS Identity Platform</a>
										</li>
										<li>Will be covered in the next exercise</li>
									</ul>
								</section>
								<section>
									<h3>Security considerations</h3>
									<ul>
										<li>Use libraries to do token validation</li>
										<li>"No trust" - "Verify everything"</li>
										<li><span style="color:red">Good practice</span>: Consider placing your API behind and api gateway (such as 
											<a href="https://azure.microsoft.com/en-us/services/api-management/"
											target="_blank">APIM</a>)</li>
										<li><span style="color:red">Good practice</span>: Consult the  
											<a href="https://www.owasp.org/index.php/OWASP_API_Security_Project"
											target="_blank">OWASP API Security Project</a>)</li>	
											
									</ul>
								</section>

					</section>

					
<!-- Exercise 10:  -->	
<section>
	<section>
		<h1>Exercise 10</h1>
		<h3>Protecting web api's, chaining api's</h3>
		<h3>The On-Behalf-Of flow<h3>
	</section>

	<section>
		<h3>Outline</h3>
		<ul>
			<li>The scenario</li>
			<li>The On-Behalf-Of Flow</li>
			<li>The Application Objects in AzureAD</li>
			<li>The SPA Client (functionally, config, code)</li>
			<li>The Quote API (functionally, config, code)</li>
			<li>The Echo API (functionally, config, code)</li>
			<li>Run and Explore</li>
			<li>Security considerations</li>
		</ul>
	</section>

	<section>
		<h3>The scenario</h3>
		<small>An Api making requests on behalf of user/machine</small>
		<img src="./graphics/export/o-b-o-scenario.jpg"
		style="width:75%; display:inline-block"> 
	
	</section>

	<section>
		<h3>The Scenario</h3>
		<small>An Api making requests on behalf of user/machine</small>
		<table style="font-size: 50%;">
			<tr>
				<td>
					<ol>
						<li>The Client requests an access token for the Echo Api</li>
						<li>The Client get an accesstoken for the Echo API - user consent</li>
						<li>The Client uses access token and requests an Echo</li>
						<li>The Echo Api validates the request and the access token</li>
						<li>The Echo Api requests an access token for the Quote Api (client permission)</li>
						<lI>The Echo Api get a access token for the Quote Api</lI>
						<li>The Echo API requests a Quote from the Quote Api</li>
						<li>The Quote Api validates the request and the access token</li>
						<li>The Quote Api returnes a cool quote</li>
						<li>The Echo Api returns a Echo w/Quote to the Client</li>
					</ol>
				</td>
				<td style="vertical-align: top;">
					<img src="./graphics/export/o-b-o-scenario.jpg">
				</td>			
			</tr>
		</table>	
	</section>

	<section>
		<h3>The On-Behalf-Of (OBO) Flow</h3>
		<ul>
			<li>oAuth2 Protocol Extension </br>-based on draft 
				<a href="https://tools.ietf.org/html/draft-ietf-oauth-token-exchange-19" target="_blank">RFC 8693 (oAuth2 Token Exchange)</a></li>
			<li><a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow"
			target="_blank">Microsoft identity platform and OAuth 2.0 On-Behalf-Of flow</a></li>
			<li>Supported by Azure AD (MS Identity Platform) on V1 and V2 endpoints. Not for Azure AD B2C</li>
			<li>May not be supported by other Security Token Services (STS) - none Azure AD</li>
			<li>Framework support will vary</li>
		</ul>
	</section>

	<section>
		<h3>The On-Behalf-Of (OBO) Flow</h3>
		<small>The middle-tier access token request (5)</small>
		<table style="font-size: 50%;">
			<tr>
				<td>
					<ul>
						<li>Request endpoint_ </br>https://login.microsoftonline.com/<tenant>/oauth2/v2.0/token</li>
						<li>Request parameters</li>
						<table>
							<tr>
								<td>grant_type</td>
								<td style="color:red">urn:ietf:params:oauth:grant-type:jwt-bearer</td>
							</tr>
							<tr>
								<td>client_id</td>
								<td>Id of the client making the request (B)</td>
							</tr>
							<tr>
								<td>client_secret</td>
								<td>The client (B) secret</td>
							</tr>
							<tr>
								<td style="color:red">assertion</td>
								<td>The access token that the client (B) got from client A in step 3. Audience in claim must be client_id of client B</td>
							</tr>
							<tr>
								<td>scope</td>
								<td>The scope that is requested (The scope in client C)</td>
							</tr>
							<tr>
								<td>
									requested_token_use
								</td>
								<td style="color:red">on_behalf_of</td>
							</tr>
						</table>
					</ul>
				</td>
				<td style="vertical-align: top;">
					<img src="./graphics/export/o-b-o-scenario.jpg">
				</td>			
			</tr>
		</table>	
	</section>

	<!-- <section>
		<h3>The On-Behalf-Of (OBO) Flow</h3>
		<small>The middle-tier access token request (5)</small>
		<table style="font-size: 50%;">
			<tr>
				<td>
					<ul>
						<li>Example POST request</br></br>
						<span>
							POST /...../oauth2/v2.0/token</br>
							HTTP/1.1</br>
							Content-type: application/x-www-form-urlencoded </br>
							Host: login.microsoftonline.com </br></br>
							
							grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer</br>
							&client_id=b1621ac1-750a-4ee2-915b-0388732a97d3</br>
							&client_secret=</br>
							&assertion=ey.....tg</br>
							&scope=api://..../GetQuote</br>
							&requested_token_use=on_behalf_of</br>
						</span>
						</li>
					</ul>
				</td>
				<td style="vertical-align: top;">
					<img src="./graphics/export/o-b-o-scenario.jpg">
				</td>			
			</tr>
		</table>	
	</section> -->

	<section>
		<h3>The On-Behalf-Of (OBO) Flow</h3>
		<small>The middle-tier access token request response (6)</small>
		<table style="font-size: 50%;">
			<tr>
				<td>
					<ul>
						<li>Parameters in response</li>
						<table>
							<tr>
								<td>token_type</td>
								<td>Bearer</td>
							</tr>
							<tr>
								<td>scope</td>
								<td>The requested scope (exposed by client C)</td>
							</tr>
							<tr>
								<td>expires_in</td>
								<td>Number of seconds until the access token expire</td>
							</tr>
							<tr>
								<td>access_token</td>
								<td>The actual access token that will be used by client B when requesting from client C (step 7)</td>
							</tr>
							
						</table>
					</ul>
				</td>
				<td style="vertical-align: top;">
					<img src="./graphics/export/o-b-o-scenario.jpg">
				</td>			
			</tr>
		</table>	
	</section>
	
	<section>
		<h3>The Application Objects in AzureAD</h3>
		<small>All objects that we want to protect must be registered in Azure AD</small>
		<table style="font-size: 50%;">
			<tr>
				<td>
					<ul>
						<li>
							SPA (Client A). Must have a client_id and client_secret (depending on which flows that are used). No changes compared to previous exercises
						</li>
						<li>
							The Echo Api (Client B). Must have a client_id and a client_secret. Must expose scope for api - Echo.Read. 
							Compared to previous exercises - we need a client_secret to be able to request a token on-behalf-of
						</li>
						<li>The Quote Api (Client C). Must have a client_id. Must expose scope for api - GetQuote. Compared to previous exercises - this is a new registration</li>
					</ul>
				</td>
				<td style="vertical-align: top;">
					<img src="./graphics/export/o-b-o-scenario.jpg">
				</td>			
			</tr>
		</table>	
	</section>

	<section>
		<h3>Preparing for the exercise</h3>
		<ul>
			<li>Code lives in ./ex-10</li>
			<li>3 projects</li>
			<ul>
				<li>Client A - SPA (./ex-10/spa)</li>
				<li>Client B - Echo Api (./ex-10/echoapi)</li>
				<li>Client C - Quote Api (./ex-10/quoteapi)</li>
			</ul>
			<li><span style="color: red">Remember:</span> Each project must be executed in a separate terminal window on your computer</li>
		</ul>
	</section>

	<section>
		<h3>The SPA Client</h3>
		<ul>
			<li>No code changes from previous examples (ex-9)</li>
			<li>Update in "JavaSciptSPA/index.html
				(<a href="#/17/5" target="_blank">Link to ex-9</a>)
			</li>
			<li>In a separate terminal window, from ./ex-10/spa</li>
			<ul>
				
				<li>Set environment variable PORT=3000</li>
				<li>Do a <span style="color :red">npm install</span></li>
				<li>Start SPA client (A) by doing <span style="color :red">npm start</span></li>
			</ul>
		</ul>
	</section>

	<section>
		<h3>The Quote API</h3>
		<ul style="font-size: 70%;">
			<li>New functionalliy - based on Echo api from ex-9</li>
			<li>Examine code in ./ex-10/quoteapi</li>
			<li>Create new App Registration for Quote Api in Azure AD</li>
			<ul>
				<li>Expose api/scope: <span style="color: red">GetQuote</span></li>
				<li>Authorise client application (the EchoAPI (B) to access the API)(from Expose Api section)</li>
				<li style="color: red;">This is an example for application/machine trust - no user consent involved!</li>
			</ul>
			<li>Update config in app (./routes/quote.js)</li>
			<ul>
				<li>validateOptions: audience (clientID of Quote API)</li>
				<li>jwt.verify(...)</li>
				<ul></li>
					<li>decoded.appid = clientID of Echo Api
				</ul>
			</ul>
			<li>In a separate terminal window, from ./ex-10/quoteapi</li>
			<ul>
				<li>Set environment variable PORT=3200</li>
				<li>Do a <span style="color :red">npm install</span></li>
				<li>Start Quote Api (C) by doing <span style="color :red">npm start</span></li>
			</ul>
		</ul>
	</section>

	<section>
		<h3>The Echo API</h3>
		<ul style="font-size: 70%;">
			<li>New functionalliy - request quote and return a part of echo request</li>
			<li>Examin code for changes (./routes/index.js, ./src/quotes.js)</li>
			<li>Verify config according to previous example (validate options) (<a href="#/17/6" target="_blank">ex-9</a>)</li>
			<li>Update the scope in the request form in quotes.js to reflect to Quotes scope (api://...../GetQuote)</li>
			<li>Update the decoded.appid= in quotes.js to validate that the request is coming from the echoApo (appid) 
			<li>Verify the url for the Quote Api in getQuote in quotes.js</li>			
			<li>In a separate terminal window, from ./ex-10/echoapi</li>
			<ul>
				<li>Set environment variable PORT=3100, CLIENT_ID , CLIENT_SECRET</li>
				<li>Do a <span style="color :red">npm install</span></li>
				<li>Start Echo api (B) by doing <span style="color :red">npm start</span></li>
			</ul>
		</ul>
	</section>
	
	<section>
		<h3>Run & Explore</h3>
		<table >
			<tr>
				<td>
					<ul>
						<li>You now have 3 applications running in 3 terminal windows</li>
						<li>Login to the SPA, trigger the <strong>Echo functionality</strong> and observe cool quotes, logging etc </li>
						<li>Explore code, make changes and observe effect</li>
					</ul>
				</td>
				<td style="vertical-align: top;">
					<img src="./graphics/export/o-b-o-scenario.jpg">
				</td>			
			</tr>
		</table>
	</section>

	<section>
		<h3>Security consideratons</h3>
		<ul style="font-size: 80%;">
			<li>Things are getting complex - which always gives us security issues</li>
			<ul>
				<li>Creds and config needs to be managed properly</li>
				<li>Borders between staging environments needs to be clear (dev, test, prod)</li>
				<li>Application architecture should be done carefully</li>
			</ul>
			<li>Use frameworks as much as possible to handle the flows! We only do it the hard way in this exercise to be able understand</li>
			<li>Establish good practise around debugging/tracing to understand network flow (Burp, Fiddler)</li>
			<ul>
				<li>
					For NodeJS i recommend the <a href="https://www.npmjs.com/package/global-agent" target="_blank">Global Agent</a> module to enable debugging using a network proxy
				</li>
			</ul>
		</ul>
	</section>
</section>


<!-- Exercise 11 :  -->	

					<section>
						<section>
							<h3>Exercise 11</h3>
							<h2>Deploying to the Cloud</h2>
							<small>Radix for the win</small>
						</section>

						<section>
							<h3>The code</h3>
							<ul style="font-size: 80%;">
								<li>Fork from code in ex-4</li>
								<li>Important changes going from local to the cloud</li>
								<ul>
									<li>The deployment environment becomes dynamic. Potential specific to the cloud provider technology.
									<li>We use Docker to be a bit more "multi cloud" ready</li>
									<li>Important URLs, like redirect_url, becomes dynamic. Added some logic to handle this for Radix </br>(in <span style="color: red">./src/app.js , ./src/authutils.js</span>)</li>
									<li>Still keeping secrets outside code. Storing the CLIENT_SECRET as a secret in Radix</li>
								<ul>
							</ul>
						</section>

						<section>
							<h2>Tasks</h2>
							<ul>
								<li>Fork the project at <span style="color:red">https://github.com/larskaare/sMailandStuff</span>
								</br> to your own user on github.com</li>
								<li>Use the instructions in the README.md to configure and run the application locally (NodeJs and Docker)</li>
								<li>Deploy to the cloud using Radix. A good place to start would be <a href="https://www.radix.equinor.com" target="_blank">The Radix Getting Started</a></li>
								<li>↓</li>
							</ul>
						</section>
						<section>
							<h2>Traps ...</h2>
							<ul>
								<li>The app name in radixconfig</li>
								<li>Update redirect URL in app registration</li>
								<li>Update CLIENTID in radixconfig</li>
							</ul>
						</section>
					</section>


					<section>
						<section>
							<h1>Security Resources</h1>
						</section>
						<section>
							<h3>Links to relevant security resources</h3>
							<ul>
								<li><a href="https://tools.ietf.org/html/rfc6819" target="_blank">oAuth2 Threat Model and Security Considerations</a></li>
								<li><a href="https://tools.ietf.org/html/draft-ietf-oauth-security-topics" target="_blank">OAuth Security Topics</a></li>
								<li><a href="https://owasp.org/www-project-top-ten/" target="_blank">OWASP Top-10 Project</a></li>
								<li><a href="https://owasp.org/www-project-api-security/" target="_blank">OWASP API Security Project</a></li>
							
							</ul>
						</section>

				</section>


				<section>
					<h3>Going deeper into the A&A topic ...</h3>
					<img src="./graphics/oauth2inaction.jpeg" width="40%">
				</section>


					<section>
							<section>
								<h1>Clean-Up</h1>
								<ul>
									<li>Clean-up in Azure AD App Registration</li>
									<li>Clean-up in Radix - remove app after usage</li>
								</ul>
							</section>
					</section>

					<section>
						<section>
							<h1>Thank You!</h1>
							<ul>
								<li>Join <a href="https://equinor.slack.com/archives/CMM6FSW5V" target="_blank">#appsec</a> on Slack</li>
								<li>Continue discussion on A&A and other application security related topics</li>
							</ul>
						</section>
				</section>

			</div>
		</div>

		
		<script src="dist/reveal.js"></script>
		<!-- <script src="plugin/notes/notes.js"></script> -->
		<!-- <script src="plugin/markdown/markdown.js"></script> -->
		<script src="plugin/highlight/highlight.js"></script>
		<script src="plugin/zoom/zoom.js"></script>
		<script src="plugin/search/search.js"></script>

		<script>

			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				center: true,
				hash: true,
				slideNumber: true,
				hash: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// More info https://github.com/hakimel/reveal.js#dependencies
				// dependencies: [
				// 	{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
				// 	{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
				// 	{ src: 'plugin/highlight/highlight.js', async: true },
				// 	{ src: 'plugin/search/search.js', async: true },
				// 	{ src: 'plugin/zoom-js/zoom.js', async: true },
				// 	{ src: 'plugin/notes/notes.js', async: true }
				// ]
			

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealHighlight, RevealZoom, RevealSearch ]
			});

		</script>

	</body>
</html>
